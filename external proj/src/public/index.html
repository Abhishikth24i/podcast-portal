<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Podcast Publishing Portal</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<link href="/styles.css" rel="stylesheet" />
</head>
<body>
	<div class="container my-4" style="max-width: 960px;">
		<h1 class="mb-4">Podcast Publishing Portal</h1>

		<div class="card mb-4">
			<div class="card-header">Upload Audio</div>
			<div class="card-body">
				<form id="uploadForm" class="row g-3 align-items-end">
					<div class="col-12 col-md-4">
						<label for="audio" class="form-label">Audio file</label>
						<input type="file" class="form-control" id="audio" name="audio" accept="audio/*" required />
					</div>
					<div class="col-12 col-md-3">
						<label for="title" class="form-label">Title (optional)</label>
						<input type="text" class="form-control" id="title" name="title" />
					</div>
					<div class="col-12 col-md-3">
						<label for="description" class="form-label">Description (optional)</label>
						<input type="text" class="form-control" id="description" name="description" />
					</div>
					<div class="col-12 col-md-2 d-grid">
						<button type="submit" class="btn btn-primary">Upload</button>
					</div>
				</form>
				<div id="uploadMsg" class="form-text mt-2"></div>
			</div>
		</div>

		<div class="card">
			<div class="card-header d-flex justify-content-between align-items-center">
				<span>Library</span>
				<button id="refresh" class="btn btn-outline-secondary btn-sm">Refresh</button>
			</div>
			<div class="list-group list-group-flush" id="list"></div>
		</div>

		<!-- Edit Modal -->
		<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Edit Metadata</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<form id="editForm" class="row g-3">
							<input type="hidden" id="editId" />
							<div class="col-12">
								<label for="editTitle" class="form-label">Title</label>
								<input type="text" id="editTitle" class="form-control" />
							</div>
							<div class="col-12">
								<label for="editDesc" class="form-label">Description</label>
								<textarea id="editDesc" class="form-control" rows="3"></textarea>
							</div>
						</form>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
						<button type="button" id="saveEdit" class="btn btn-primary">Save</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>
	async function fetchList() {
		const list = document.getElementById('list');
		list.innerHTML = '';
		try {
			const res = await fetch(`/api/files?t=${Date.now()}`, { cache: 'no-store' });
			if (!res.ok) throw new Error('Failed to load list');
			const files = await res.json();
			for (const f of files) {
			const item = document.createElement('div');
			item.className = 'list-group-item';
			const title = f?.metadata?.title || f.filename;
				const desc = f?.metadata?.description ? `<p class="mb-1">${f.metadata.description}</p>` : '';
				item.innerHTML = `
					<div class="d-flex w-100 justify-content-between align-items-start">
						<div class="me-3">
							<h6 class="mb-1">${title}</h6>
							${desc}
							<small class="text-muted">${new Date(f.uploadDate).toLocaleString()} • ${(f.length / (1024*1024)).toFixed(2)} MB • ${f.contentType || ''}</small>
						</div>
						<div class="btn-group">
							<a class="btn btn-sm btn-outline-primary" href="/api/files/${f._id}/stream" target="_blank">Stream</a>
							<a class="btn btn-sm btn-outline-secondary" href="/api/files/${f._id}/download">Download</a>
							<button data-id="${f._id}" data-title="${title.replace(/"/g, '&quot;')}" data-desc="${(f?.metadata?.description || '').replace(/"/g, '&quot;')}" class="btn btn-sm btn-outline-warning edit">Edit</button>
							<button data-id="${f._id}" class="btn btn-sm btn-outline-danger delete">Delete</button>
						</div>
					</div>
				`;
			list.appendChild(item);
			}
		} catch (err) {
			const alert = document.createElement('div');
			alert.className = 'list-group-item text-danger';
			alert.textContent = err.message || 'Failed to load list';
			list.appendChild(alert);
		}
	}

		document.getElementById('uploadForm').addEventListener('submit', async (e) => {
		e.preventDefault();
		const form = new FormData();
		const fileInput = document.getElementById('audio');
		const title = document.getElementById('title').value;
		const description = document.getElementById('description').value;
		if (!fileInput.files[0]) return;
			// Append text fields first so Busboy receives them before the file
			form.append('title', title);
			form.append('description', description);
			form.append('audio', fileInput.files[0]);
		const msg = document.getElementById('uploadMsg');
		msg.className = 'form-text mt-2 text-muted';
		msg.textContent = 'Uploading…';
		try {
				const res = await fetch('/api/upload/audio', { method: 'POST', body: form });
				if (!res.ok) {
					let errText = 'Upload failed';
					try {
						const data = await res.json();
						errText = data?.message || errText;
					} catch {}
				msg.className = 'form-text mt-2 text-danger';
				throw new Error(errText);
				}
			msg.className = 'form-text mt-2 text-success';
			msg.textContent = 'Upload successful';
			fileInput.value = '';
			fetchList();
		} catch (err) {
			msg.textContent = err.message || 'Upload failed';
		}
	});

	fetchList();
	const refreshBtn = document.getElementById('refresh');
	refreshBtn.addEventListener('click', async () => {
		refreshBtn.disabled = true;
		try { await fetchList(); } finally { refreshBtn.disabled = false; }
	});
	const listEl = document.getElementById('list');
	listEl.addEventListener('click', async (e) => {
		if (e.target.classList.contains('delete')) {
			const id = e.target.getAttribute('data-id');
			if (!confirm('Delete this file?')) return;
			await fetch(`/api/files/${id}`, { method: 'DELETE' });
			fetchList();
		}
		if (e.target.classList.contains('edit')) {
			const id = e.target.getAttribute('data-id');
			const title = e.target.getAttribute('data-title') || '';
			const desc = e.target.getAttribute('data-desc') || '';
			document.getElementById('editId').value = id;
			document.getElementById('editTitle').value = title;
			document.getElementById('editDesc').value = desc;
			const modal = new bootstrap.Modal(document.getElementById('editModal'));
			modal.show();
		}
	});
	// Save edits
	document.getElementById('saveEdit').addEventListener('click', async () => {
		const id = document.getElementById('editId').value;
		const title = document.getElementById('editTitle').value;
		const description = document.getElementById('editDesc').value;
		const btn = document.getElementById('saveEdit');
		btn.disabled = true;
		try {
			const res = await fetch(`/api/files/${encodeURIComponent(id)}`, {
				method: 'PATCH',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ title, description })
			});
			if (!res.ok) {
				let msg = 'Failed to update';
				try { const data = await res.json(); msg = data?.message || msg; }
				catch { try { msg = await res.text() || msg; } catch {} }
				alert(msg);
				return;
			}
			await fetchList();
			bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
		} finally {
			btn.disabled = false;
		}
	});
	</script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>


