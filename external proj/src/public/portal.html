<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Podcast Portal</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<link href="/styles.css" rel="stylesheet" />
</head>
<body>
    <nav class="navbar navbar-expand-lg py-3 bg-white border-bottom sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">PODCASTER</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav" aria-controls="nav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="nav">
                <ul class="navbar-nav ms-3">
                    <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="#features">Resources</a></li>
                    <li class="nav-item"><a class="nav-link" href="#newsletter">Newsletter</a></li>
                    <li class="nav-item"><a class="nav-link" href="#about">About</a></li>
                </ul>
                <ul class="navbar-nav ms-auto align-items-lg-center gap-2">
                    <form class="d-none d-lg-flex" role="search" id="navSearch" onsubmit="event.preventDefault(); window.doSearch && window.doSearch(this.query.value);">
                        <input class="form-control me-2" type="search" name="query" placeholder="Search" aria-label="Search" style="width: 220px;">
                    </form>
                    <li class="nav-item d-none d-lg-block"><a class="btn btn-dark rounded-pill px-3" href="/portal.html">Upload</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-4" style="max-width: 960px;">
        <h1 class="mb-4">Podcast Publishing Portal</h1>

		<div class="card mb-4">
			<div class="card-header">Upload Audio</div>
			<div class="card-body">
				<form id="uploadForm" class="row g-3 align-items-end">
					<div class="col-12 col-md-4">
						<label for="audio" class="form-label">Audio file</label>
						<input type="file" class="form-control" id="audio" name="audio" accept="audio/*" required />
    </div>
					<div class="col-12 col-md-3">
						<label for="title" class="form-label">Title (optional)</label>
						<input type="text" class="form-control" id="title" name="title" />
					</div>
					<div class="col-12 col-md-3">
						<label for="description" class="form-label">Description (optional)</label>
						<input type="text" class="form-control" id="description" name="description" />
					</div>
					<div class="col-12 col-md-2 d-grid">
						<button type="submit" class="btn btn-primary">Upload</button>
					</div>
				</form>
				<div id="uploadMsg" class="form-text mt-2"></div>
			</div>
		</div>

        <div class="card mb-3">
            <div class="card-body">
                <h6 class="mb-2">Player</h6>
                <audio id="player" controls preload="none" style="width:100%"></audio>
                <small id="nowPlaying" class="text-muted"></small>
            </div>
        </div>

        <div class="card">
			<div class="card-header d-flex justify-content-between align-items-center">
				<span>Library</span>
				<button id="refresh" class="btn btn-outline-secondary btn-sm">Refresh</button>
			</div>
			<div class="list-group list-group-flush" id="list"></div>
		</div>

		<!-- Edit Modal -->
		<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Edit Metadata</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<form id="editForm" class="row g-3">
							<input type="hidden" id="editId" />
							<div class="col-12">
								<label for="editTitle" class="form-label">Title</label>
								<input type="text" id="editTitle" class="form-control" />
							</div>
							<div class="col-12">
								<label for="editDesc" class="form-label">Description</label>
								<textarea id="editDesc" class="form-control" rows="3"></textarea>
							</div>
						</form>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
						<button type="button" id="saveEdit" class="btn btn-primary">Save</button>
					</div>
				</div>
			</div>
		</div>
	</div>

    <script>
    // read ?q= from URL and trigger search
    const urlQ = new URLSearchParams(window.location.search).get('q') || '';
    if (urlQ) {
        const navForm = document.getElementById('navSearch');
        if (navForm) navForm.query.value = urlQ;
    }

    window.doSearch = async function(q) {
        await fetchList(q);
    }
    async function fetchList(q) {
		const list = document.getElementById('list');
		list.innerHTML = '';
		try {
            const qp = new URLSearchParams();
            if (q && q.trim()) qp.set('q', q.trim());
            qp.set('t', Date.now());
            const res = await fetch(`/api/files?${qp.toString()}`, { cache: 'no-store' });
			if (!res.ok) throw new Error('Failed to load list');
			const files = await res.json();
			for (const f of files) {
				const item = document.createElement('div');
				item.className = 'list-group-item';
				const title = f?.metadata?.title || f.filename;
				const desc = f?.metadata?.description ? `<p class="mb-1">${f.metadata.description}</p>` : '';
                item.innerHTML = `
					<div class="d-flex w-100 justify-content-between align-items-start">
						<div class="me-3">
							<h6 class="mb-1">${title}</h6>
							${desc}
							<small class="text-muted">${new Date(f.uploadDate).toLocaleString()} • ${(f.length / (1024*1024)).toFixed(2)} MB • ${f.contentType || ''}</small>
						</div>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary stream" data-id="${f._id}" data-title="${title.replace(/"/g, '&quot;')}">Stream</button>
                            <a class="btn btn-sm btn-outline-secondary" href="/api/files/${f._id}/download">Download</a>
                            <button data-id="${f._id}" class="btn btn-sm btn-outline-danger delete">Delete</button>
                        </div>
					</div>
				`;
				list.appendChild(item);
			}
		} catch (err) {
			const alert = document.createElement('div');
			alert.className = 'list-group-item text-danger';
			alert.textContent = err.message || 'Failed to load list';
			list.appendChild(alert);
		}
	}

	document.getElementById('uploadForm').addEventListener('submit', async (e) => {
		e.preventDefault();
		const form = new FormData();
		const fileInput = document.getElementById('audio');
		const title = document.getElementById('title').value;
		const description = document.getElementById('description').value;
		if (!fileInput.files[0]) return;
		// Append text fields first so Busboy receives them before the file
		form.append('title', title);
		form.append('description', description);
		form.append('audio', fileInput.files[0]);
		const msg = document.getElementById('uploadMsg');
		msg.className = 'form-text mt-2 text-muted';
		msg.textContent = 'Uploading…';
		try {
			const res = await fetch('/api/upload/audio', { method: 'POST', body: form });
			if (!res.ok) {
				let errText = 'Upload failed';
				try {
					const data = await res.json();
					errText = data?.message || errText;
				} catch {}
				msg.className = 'form-text mt-2 text-danger';
				throw new Error(errText);
			}
			msg.className = 'form-text mt-2 text-success';
			msg.textContent = 'Upload successful';
			fileInput.value = '';
    fetchList(urlQ);
		} catch (err) {
			msg.textContent = err.message || 'Upload failed';
		}
	});

	fetchList();
	const refreshBtn = document.getElementById('refresh');
	refreshBtn.addEventListener('click', async () => {
		refreshBtn.disabled = true;
		try { await fetchList(); } finally { refreshBtn.disabled = false; }
	});
	const listEl = document.getElementById('list');
	listEl.addEventListener('click', async (e) => {
        if (e.target.classList.contains('stream')) {
            const id = e.target.getAttribute('data-id');
            const title = e.target.getAttribute('data-title') || 'Playing';
            const player = document.getElementById('player');
            const now = document.getElementById('nowPlaying');
            player.src = `/api/files/${id}/stream`;
            now.textContent = `Now playing: ${title}`;
            player.play().catch(()=>{});
            return;
        }
        if (e.target.classList.contains('delete')) {
			const id = e.target.getAttribute('data-id');
			if (!confirm('Delete this file?')) return;
			await fetch(`/api/files/${id}`, { method: 'DELETE' });
			fetchList();
		}
        // edit button removed
	});

	// Save edits
	document.getElementById('saveEdit').addEventListener('click', async () => {
		const id = document.getElementById('editId').value;
		const title = document.getElementById('editTitle').value;
		const description = document.getElementById('editDesc').value;
		const btn = document.getElementById('saveEdit');
		btn.disabled = true;
		try {
			const res = await fetch(`/api/files/${encodeURIComponent(id)}`, {
				method: 'PATCH',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ title, description })
			});
			if (!res.ok) {
				let msg = 'Failed to update';
				try { const data = await res.json(); msg = data?.message || msg; }
				catch { try { msg = await res.text() || msg; } catch {} }
				alert(msg);
				return;
			}
			await fetchList();
			bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
		} finally {
			btn.disabled = false;
		}
	});
	</script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>


